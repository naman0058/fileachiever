<% include ./header.ejs %>

<div class="content-body">
  <div class="page-titles">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="#">CMS</a></li>
      <li class="breadcrumb-item active"><a href="#">Review Pending Tasks</a></li>
    </ol>
  </div>

  <div class="container-fluid">
    <% if (tasks.length === 0) { %>
      <div class="alert alert-info">No pending tasks to review.</div>
    <% } else { %>
      <!-- Bulk action form wraps the whole table -->
      <form method="POST" action="/affiliate/update-task-status" id="bulkActionForm">
        <input type="hidden" name="status" id="bulkStatus" />
        <input type="hidden" name="reason" id="bulkReason" />

        <div class="d-flex gap-2 mb-3">
          <button type="button" id="verifySelected" class="btn btn-success btn-sm">
            Verify Selected
          </button>
          <button type="button" id="rejectSelected" class="btn btn-danger btn-sm">
            Reject Selected
          </button>
        </div>

        <div class="table-responsive">
          <table class="table table-striped table-bordered align-middle text-center">
            <thead class="table-dark">
              <tr>
                <th>
                  <input type="checkbox" id="selectAll" />
                </th>
                <th>#</th>
                <th>Title</th>
                <th>Type</th>
                <th>Submitted By</th>
                <th>Description</th>
                <th>Proof</th>
                <!-- Optional: keep per-row quick actions (can be removed if you prefer only bulk) -->
                <th>Quick Action</th>
              </tr>
            </thead>
            <tbody>
              <% tasks.forEach((task, index) => { %>
                <tr>
                  <td>
                    <input type="checkbox" class="rowCheckbox" name="taskIds[]" value="<%= task.internshipTaskId %>">
                  </td>
                  <td><%= index + 1 %></td>
                  <td><%= task.title %></td>
                  <td><%= task.task_type.charAt(0).toUpperCase() + task.task_type.slice(1) %></td>
                  <td><strong><%= task.ambassador_name %></strong></td>
                  <td style="max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                      title="<%= task.description.replace(/(<([^>]+)>)/gi, '') %>">
                    <%= task.description.replace(/(<([^>]+)>)/gi, '') %>
                  </td>
                  <td>
                    <a href="<%= task.proofLink %>" target="_blank" class="btn btn-sm btn-link text-primary">View</a>
                  </td>
                  <td>
                    <!-- Optional quick per-row actions (single update) -->
                    <form method="POST" action="/affiliate/update-task-status" class="d-flex justify-content-center gap-1 reject-form">
                      <input type="hidden" name="taskIds[]" value="<%= task.internshipTaskId %>" />
                      <input type="hidden" name="reason" class="reject-reason-input" />
                      <button type="submit" name="status" value="verified" class="btn btn-success btn-sm">Verified</button>
                      <button type="button" name="status" value="rejected" class="btn btn-danger btn-sm reject-btn">Reject</button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </form>
    <% } %>
  </div>
</div>

<% include ./footer.ejs %>

<script>
  // Select-all behavior
  const selectAll = document.getElementById('selectAll');
  const rowCheckboxes = document.querySelectorAll('.rowCheckbox');
  if (selectAll) {
    selectAll.addEventListener('change', () => {
      rowCheckboxes.forEach(cb => cb.checked = selectAll.checked);
    });
    rowCheckboxes.forEach(cb => {
      cb.addEventListener('change', () => {
        if (!cb.checked) selectAll.checked = false;
        else if ([...rowCheckboxes].every(c => c.checked)) selectAll.checked = true;
      });
    });
  }

  // Bulk actions
  const bulkForm = document.getElementById('bulkActionForm');
  const bulkStatus = document.getElementById('bulkStatus');
  const bulkReason = document.getElementById('bulkReason');

  function getSelectedCount() {
    return [...document.querySelectorAll('.rowCheckbox:checked')].length;
  }

  document.getElementById('verifySelected')?.addEventListener('click', () => {
    if (getSelectedCount() === 0) return alert('Please select at least one task.');
    bulkStatus.value = 'verified';
    bulkReason.value = ''; // ensure empty
    bulkForm.submit();
  });

  document.getElementById('rejectSelected')?.addEventListener('click', () => {
    if (getSelectedCount() === 0) return alert('Please select at least one task.');
    const reason = prompt('Please enter the reason for rejection (applied to all selected):');
    if (reason === null || reason.trim() === '') return alert('Rejection reason is required.');
    bulkStatus.value = 'rejected';
    bulkReason.value = reason.trim();
    bulkForm.submit();
  });

  // Existing per-row reject buttons (optional quick action)
  document.querySelectorAll('.reject-btn').forEach(button => {
    button.addEventListener('click', function () {
      const reason = prompt("Please enter the reason for rejection:");
      if (reason !== null && reason.trim() !== "") {
        const form = this.closest('form');
        const input = form.querySelector('.reject-reason-input');
        input.value = reason.trim();
        const hiddenReject = document.createElement('input');
        hiddenReject.type = 'hidden';
        hiddenReject.name = 'status';
        hiddenReject.value = 'rejected';
        form.appendChild(hiddenReject);
        form.submit();
      } else {
        alert("Rejection reason is required.");
      }
    });
  });
</script>
